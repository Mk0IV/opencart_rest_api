# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Разработка расширения OpenCart для импорта товаров и управления категориями

**Версия:** 1.0  
**Дата:** 19.12.2025  
**Статус:** К разработке  
**Язык:** PHP 7.4+, JavaScript ES6+  

---

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1 Назначение проекта
Создать модуль OpenCart (расширение), который обеспечивает:
- Импорт товаров из файлов (CSV, XLSX, JSON)
- Управление категориями (создание, обновление, удаление)
- Управление структурой каталога (иерархия категорий)
- Массовые операции с товарами и категориями
- Логирование всех операций импорта

### 1.2 Целевая аудитория
- Администраторы онлайн-магазинов на OpenCart 3.x / 4.x
- Владельцы магазинов с большим количеством товаров
- Системы, интегрирующие данные из различных источников

### 1.3 Основные требования
- Совместимость: OpenCart 3.0+, OpenCart 4.x
- Архитектура: MVC(L) паттерн OpenCart
- Безопасность: валидация входных данных, защита от SQL-injection
- Производительность: поддержка импорта 1000+ товаров
- Многоязычность: поддержка многоязычных описаний

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1 Основной функционал

#### 2.1.1 Модуль импорта товаров (Product Import)
**Функция:** Импорт товаров из внешних источников

**Поддерживаемые форматы:**
- CSV (с разделителями: запятая, точка с запятой, табуляция)
- XLSX (Microsoft Excel)
- JSON (структурированные данные)

**Поля для импорта:**
```
Обязательные:
- product_id (или sku для новых товаров)
- name (название товара)
- category_id (основная категория)
- price (цена)

Опциональные:
- description (описание)
- meta_description (SEO описание)
- model (модель товара)
- sku (артикул)
- quantity (остаток)
- status (статус: 0=отключено, 1=включено)
- weight (вес)
- manufacturer_id (производитель)
- image (ссылка на изображение)
```

**Процесс импорта:**
1. Загрузка файла через интерфейс админ-панели
2. Валидация структуры файла (проверка обязательных полей)
3. Предпросмотр данных (показ первых 10 записей)
4. Выбор режима обновления:
   - Add (только новые товары)
   - Update (только обновление существующих)
   - Merge (новые добавить, существующие обновить)
5. Выполнение импорта с логированием каждого шага
6. Отчет об итогах (добавлено X, обновлено Y, ошибок Z)

#### 2.1.2 Модуль управления категориями (Category Management)
**Функция:** CRUD операции над категориями и иерархией

**Операции:**
- Создание новой категории
- Обновление существующей категории
- Удаление категории
- Изменение родительской категории (иерархия)
- Массовое изменение статуса
- Переназначение товаров между категориями

**Импорт категорий:**
- Формат: CSV, XLSX, JSON
- Автоматическое создание иерархии по parent_id
- Поддержка многоязычных названий

#### 2.1.3 Управление каталогом (Catalog Management)
**Функция:** Комплексное управление структурой каталога

**Возможности:**
- Просмотр текущей иерархии категорий (древовидный вид)
- Переместить категорию в другую категорию (drag-and-drop)
- Переместить товар в категорию
- Массовое переназначение товаров
- Резервное копирование структуры каталога (экспорт)
- Статистика по категориям

### 2.2 Дополнительный функционал

#### 2.2.1 Логирование и мониторинг
- Журнал всех операций импорта (дата, пользователь, файл, результат)
- Система оповещений при ошибках критического уровня
- Возможность просмотра логов в админ-панели
- Экспорт логов

---

## 3. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### 3.1 Архитектура модуля

```
catalog/extension/module/product_importer/
├── admin/
│   ├── controller/extension/module/product_importer.php
│   ├── language/ru-ru/extension/module/product_importer.php
│   └── view/template/extension/module/
│       ├── product_importer.twig
│       ├── import_form.twig
│       ├── category_manager.twig
│       └── import_log.twig
├── model/extension/module/
│   ├── product_importer.php
│   ├── product_import_handler.php
│   └── category_import_handler.php
├── library/
│   ├── ProductImporterCSVParser.php
│   ├── ProductImporterXLSXParser.php
│   ├── ProductImporterJSONParser.php
│   ├── ProductValidator.php
│   ├── CategoryValidator.php
│   └── ImportLogger.php
├── install.sql
└── install.php
```

### 3.2 Структура БД

#### Таблица: oc_import_batch
```sql
CREATE TABLE `oc_import_batch` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `filename` VARCHAR(255),
  `file_type` VARCHAR(10),
  `total_records` INT,
  `processed_records` INT,
  `success_records` INT,
  `failed_records` INT,
  `status` VARCHAR(20),
  `mode` VARCHAR(20),
  `admin_id` INT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 Безопасность

**Обязательно реализовать:**
1. **Валидация входных данных**
   - Проверка типов файлов (whitelist)
   - Максимальный размер файла: 100 MB
   - Проверка структуры данных в файле

2. **Защита от атак**
   - SQL-injection: использование prepared statements
   - XSS: экранирование выходных данных в шаблонах
   - CSRF: проверка токенов в формах

3. **Контроль доступа**
   - Проверка прав администратора (admin.permission)
   - Логирование попыток несанкционированного доступа

### 3.4 Производительность

**Требования:**
- Импорт 1000 товаров: < 60 секунд
- Пакетная обработка: chunks по 100 записей
- Кэширование категорий во время импорта
- Отложенная индексация товаров (если есть)

---

## 4. ТРЕБОВАНИЯ К ПОЛЬЗОВАТЕЛЬСКОМУ ИНТЕРФЕЙСУ

### 4.1 Страница импорта товаров

**Элементы интерфейса:**
1. **Форма загрузки файла**
   - Drag-and-drop зона
   - Кнопка "Выбрать файл"
   - Выбор типа файла (CSV, XLSX, JSON)

2. **Параметры импорта**
   - Выбор режима: Add / Update / Merge
   - Выбор языка для текстовых полей
   - Выбор основной категории (по умолчанию)

3. **Предпросмотр**
   - Таблица с первыми 10 записями
   - Возможность сопоставить колонки файла с полями OpenCart

4. **Результаты импорта**
   - Сводка: добавлено X, обновлено Y, ошибок Z
   - Список товаров с ошибками (если есть)
   - Кнопка "Скачать отчет об ошибках"

### 4.2 Страница управления категориями

**Элементы интерфейса:**
1. **Древовидный просмотр категорий**
   - Иерархическое отображение категорий
   - Иконки для вкл/выкл статуса
   - Счетчик товаров в категории

2. **Операции над категориями**
   - Кнопка "Новая категория"
   - Drag-and-drop для перемещения
   - Контекстное меню: Редактировать / Удалить

---

## 5. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### 5.1 Пример CSV файла
```csv
sku,name,price,category_id,description,quantity,status
SKU001,Товар 1,1500,5,"Описание товара 1",100,1
SKU002,Товар 2,2000,5,"Описание товара 2",50,1
```

### 5.2 Пример JSON файла
```json
{
  "products": [
    {
      "sku": "SKU001",
      "name": "Товар 1",
      "price": 1500,
      "category_id": 5,
      "description": "Описание товара 1",
      "quantity": 100,
      "status": 1
    }
  ]
}
```

---

## 6. ПЛАН РАЗРАБОТКИ

### Фаза 1: Инфраструктура (3 дня)
- [ ] Создание структуры папок модуля
- [ ] Создание таблиц БД (install.sql)
- [ ] Создание базового контроллера админ-панели
- [ ] Создание базовых моделей

### Фаза 2: Импорт товаров (5 дней)
- [ ] Реализация парсеров (CSV, XLSX, JSON)
- [ ] Реализация валидатора товаров
- [ ] Реализация обработчика импорта
- [ ] Интеграция с системой логирования

### Фаза 3: Управление категориями (3 дня)
- [ ] Реализация CRUD операций для категорий
- [ ] Реализация валидатора категорий
- [ ] Импорт категорий из файлов

### Фаза 4: Пользовательский интерфейс (4 дня)
- [ ] Создание шаблонов (Twig)
- [ ] JavaScript для drag-and-drop, AJAX
- [ ] Страница логов

### Фаза 5: Тестирование и оптимизация (2 дня)
- [ ] Функциональное тестирование
- [ ] Тестирование безопасности
- [ ] Тестирование производительности

### Фаза 6: Документация (1 день)
- [ ] README.md
- [ ] API документация
- [ ] Руководство администратора

---

## 7. КРИТЕРИИ ПРИЕМКИ

### Функциональность
- [x] Импорт товаров из CSV, XLSX, JSON
- [x] Режимы: Add, Update, Merge работают корректно
- [x] CRUD для категорий работает без ошибок
- [x] Логирование всех операций функционирует

### Безопасность
- [x] Валидация всех входных данных
- [x] Защита от SQL-injection
- [x] Защита от XSX атак
- [x] Контроль доступа

### Производительность
- [x] Импорт 1000 товаров < 60 сек
- [x] Нет утечек памяти
- [x] Кэширование работает

---

**Подготовлено:** AI Agent  
**Дата подготовки:** 19.12.2025  
**Статус:** АКТУАЛЬНО